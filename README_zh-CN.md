# 实时消息内联图像生成器

## 概述

**实时消息内联图像生成器** 是一个为 SillyTavern 设计的强大扩展，它将动态的、由内容驱动的图像生成功能直接带入您的聊天体验中。它能智能地解析角色消息中的特定触发模式，并实时生成图像，然后将它们显示在集成度高、可交互的精美容器中。

本扩展支持两种主要操作模式：一种是使用内置 `/imagine` 命令的传统模式，另一种是与 **Enhanced ComfyUI Generator (ECG)** 扩展进行高级集成，以实现无与伦比的性能、稳定性以及视频生成等功能。

## 功能特性

- **内容驱动生成**: 根据直接嵌入在角色对话中的触发器和提示词生成图像和视频。
- **双重生成模式**:
    - **传统模式**: 利用标准的 `/imagine` 斜杠命令进行简单的图像生成。
    - **ECG 集成模式**: 将生成任务卸载到 `enhanced-comfyui-generator` 扩展，以启用高级功能。
- **高级 ECG 功能**:
    - **视频生成**: 通过链式调用 `txt2img` 和 `img2vid` 任务，支持 `img2vid` 工作流。
    - **多实例支持**: 与 ECG 的双 ComfyUI 实例路由协同工作，以防止图像和视频任务之间的模型加载延迟。
    - **稳定与并发**: 利用 ECG 的中央任务调度器处理多个生成请求，避免冲突。
- **交互式图像容器**:
    - 用一个自定义 UI 替换普通图像，该 UI 包含**重新生成**、**全屏查看**和**隐藏**等控件。
    - 显示生成所用的提示词和元数据。
    - 根据输出文件自动渲染 `<video>` 或 `<img>` 标签。
- **可自定义的触发器**: 传统模式和 ECG 模式都使用完全可自定义的正则表达式模式来检测消息中的生成提示。
- **风格管理**: 应用预定义的艺术风格（如照片级写实、动漫）和自定义的负向提示词来微调您的图像。

## 安装

本扩展设计为通过 SillyTavern 的扩展管理器直接从其 Git 仓库安装。

1.  **导航到下载选项卡**: 打开 SillyTavern 并转到“下载”选项卡（云图标）。
2.  **安装扩展**: 在“安装扩展”部分，将以下仓库 URL 粘贴到文本字段中：
    ```
    https://github.com/krisshen2021/live-msg-inline-Img-generator
    ```
3.  **点击“安装”**: 扩展将被自动下载并安装。
4.  **启用扩展**: 转到“扩展”选项卡（拼图图标），在列表中找到“Live Message Inline Image Generator”，并勾选“启用”框。
5.  **重新加载 UI**: 需要重新加载 UI 才能使扩展生效。

## 配置

1.  **依赖项**: 为了获得最佳体验和高级功能（如视频），需要安装并配置 **Enhanced ComfyUI Generator (ECG)** 扩展。
2.  **设置**:
    - 导航到 SillyTavern 中的 `扩展` 面板（拼图图标）。
    - 在设置列表中找到“Live Message Inline Image Generator”。
    - **选择您的模式**:
        - **传统模式**: 保持 `使用 Enhanced ComfyUI Generator` 未选中。根据需要配置触发器正则表达式和 `/imagine` 设置。
        - **ECG 模式**:
            - 勾选 `使用 Enhanced ComfyUI Generator`。
            - 一个新的面板将会出现。配置您的触发器正则表达式（它与传统模式的不同！）。
            - 选择您已为静态图像 (`txt2img`) 和动态视频 (`img2vid`) 配置的 ECG 工作流。
            - 为每个工作流设置默认尺寸。

## 使用方法

本扩展的核心功能是从角色的消息中触发图像生成。这是通过在消息中包含一个特殊的 `<span>` 标签来实现的。

### ECG 模式 (推荐)

在您的角色消息中，包含一个带有两个关键属性的 `<span>`：
- `data-prompt`: 用于图像/视频的正向提示词。
- `data-img-gen`: 生成类型。使用 `txt2img` 表示静态图像，`img2img` 表示视频。

**静态图像示例:**
```html
我正走在一片阳光普照的森林里。 <span data-prompt="一片美丽的森林，电影般的灯光，4K，杰作" data-img-gen="txt2img"></span>
```

**视频示例:**
```html
看我潇洒地拔出我的剑！ <span data-prompt="一个骑士从剑鞘中拔出一把发光的剑的特写镜头，史诗般的奇幻，火花四溅" data-img-gen="img2img">骑士拔出了他的刀刃。</span>
```
*注意: 在 `img2img` 示例中，span 标签内的文本 (`骑士...`) 可以用作链式生成提示的额外上下文。*

### 传统模式

在传统模式下，`<span>` 只需要一个 `data-prompt` 属性。

**示例:**
```html
这是我的样子： <span data-prompt="一位有着银色头发和发光蓝眼睛的美丽精灵的肖像"></span>
```

扩展将自动检测这些 span 标签，将它们从最终消息中隐藏，并在生成成功后用交互式图像容器替换它们。
